<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OSMD Renderer</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            background: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            width: 100vw;
        }

        body.dark-mode {
            background-color: #000000;
        }

        body.light-mode {
            background-color: #ffffff;
        }

        #osmd-container {
            width: 100vw;
            height: 100%;
        }

        #error-display {
            color: #d32f2f;
            background: #ffebee;
            padding: 16px;
            margin: 10px;
            border-radius: 8px;
            display: none;
            font-size: 14px;
        }
    </style>
    <script src="../js/opensheetmusicdisplay.min.js"></script>
</head>

<body>
    <div id="error-display"></div>
    <div id="osmd-container"></div>

    <script>
        let osmd;
        let cursor;
        let lastXml = "";
        let lastDarkMode = false;
        let lastMode = "fullSheet";
        let timestampMap = [];
        let totalMusicalDuration = 0;
        let isRendered = false;
        const container = document.getElementById('osmd-container');

        async function initOSMD(darkMode) {
            try {
                osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay(container, {
                    autoResize: false,
                    drawTitle: false,
                    drawSubtitle: false,
                    drawComposer: false,
                    drawLyrics: true,
                    drawPartNames: false,
                    renderingBackend: "svg",
                    coloringEnabled: true,
                    defaultColorMusic: darkMode ? "#FFFFFF" : "#000000",
                    pageFormat: "endless",
                    drawingParameters: "compact"
                });
                console.log("OSMD Initialized");
            } catch (err) {
                showError("Init failed", err.message);
            }
        }

        async function renderXML(xmlString, darkMode = false, mode = 'fullSheet') {
            isRendered = false;
            lastXml = xmlString;
            lastDarkMode = darkMode;
            lastMode = mode;

            if (!osmd) {
                await initOSMD(darkMode);
            }

            try {
                container.innerHTML = "";
                document.body.className = darkMode ? 'dark-mode' : 'light-mode';

                const isHorizontal = mode === 'lineByLine';
                document.body.style.overflowX = isHorizontal ? 'auto' : 'hidden';

                const width = window.innerWidth;

                // Aggressive zoom and grouping for portrait
                let zoomBase = width < 500 ? 500 : 700;
                let zoom = width / zoomBase;
                if (zoom < 0.45) zoom = 0.45;
                if (zoom > 1.2) zoom = 1.2;

                osmd.setOptions({
                    defaultColorMusic: darkMode ? "#FFFFFF" : "#000000",
                    defaultColorLabel: darkMode ? "#FFFFFF" : "#000000",
                    renderSingleHorizontalStaffline: isHorizontal,
                    drawingParameters: "compact",
                    pageFormat: "endless",
                    drawPartNames: false,
                    autoResize: false,
                    drawLyrics: true
                });

                if (!isHorizontal) {
                    // Use 1 measure per line on narrow screens to prevent overflow
                    osmd.setOptions({ measuresPerLine: width < 500 ? 1 : 2 });
                }

                osmd.zoom = zoom;

                await osmd.load(xmlString);
                osmd.render();

                // Secondary fit check
                if (!isHorizontal) {
                    const svg = container.querySelector('svg');
                    if (svg) {
                        const svgWidth = svg.getBBox().width;
                        if (svgWidth > width) {
                            osmd.zoom = osmd.zoom * (width / svgWidth) * 0.98;
                            osmd.render();
                        }
                    }
                }

                cursor = osmd.cursor;
                cursor.show();

                buildTimestampMap();

                isRendered = true;
                if (window.OSMD && window.OSMD.postMessage) {
                    window.OSMD.postMessage("rendered");
                }
                console.log(`Render complete. Mode: ${mode}, Measures/Line: ${width < 500 ? 1 : 2}, Zoom: ${osmd.zoom}`);
            } catch (err) {
                showError("Render failed", err.message);
            }
        }

        function buildTimestampMap() {
            timestampMap = [];
            cursor.reset();
            let step = 0;

            while (!cursor.Iterator.EndReached) {
                const currentTime = cursor.Iterator.currentTime.RealValue;
                timestampMap.push({ time: currentTime, step: step });
                cursor.next();
                step++;
            }

            if (timestampMap.length > 0) {
                totalMusicalDuration = timestampMap[timestampMap.length - 1].time;
            }

            cursor.reset();
        }

        let currentStepIndex = -1;
        function syncToTime(timeMs, audioDurationMs) {
            if (!isRendered || !osmd || !cursor || timestampMap.length === 0 || !audioDurationMs) return;

            const targetMusicalTime = (timeMs / audioDurationMs) * totalMusicalDuration;

            let closestStep = 0;
            for (let i = 0; i < timestampMap.length; i++) {
                if (timestampMap[i].time <= targetMusicalTime) {
                    closestStep = i;
                } else {
                    break;
                }
            }

            if (closestStep !== currentStepIndex) {
                cursor.reset();
                for (let i = 0; i < closestStep; i++) {
                    cursor.next();
                }
                currentStepIndex = closestStep;

                if (lastMode === 'fullSheet') {
                    const cursorElement = cursor.cursorElement;
                    if (cursorElement) {
                        cursorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            }
        }

        function setTheme(darkMode) {
            lastDarkMode = darkMode;
            document.body.className = darkMode ? 'dark-mode' : 'light-mode';
            if (osmd) {
                osmd.setOptions({
                    defaultColorMusic: darkMode ? "#FFFFFF" : "#000000",
                    defaultColorLabel: darkMode ? "#FFFFFF" : "#000000",
                });
                osmd.render();
            }
        }

        function showError(title, message) {
            const errorDiv = document.getElementById('error-display');
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = `<strong>${title}:</strong> ${message}`;
            console.error(title, message);
        }

        window.renderXML = renderXML;
        window.setTheme = setTheme;
        window.syncToTime = syncToTime;
        window.updateCursor = () => { if (cursor) cursor.next(); };
        window.resetCursor = () => { if (cursor) cursor.reset(); };
    </script>
</body>

</html>